<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UT-Visualizer Pro (v24: Miyasho Special)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --bg-color: #1a1a1a; --panel-color: #262626; --accent-color: #00ff41; --text-color: #e0e0e0; --grid-color: rgba(0, 255, 65, 0.05); }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Courier New', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { padding: 10px 20px; border-bottom: 2px solid var(--accent-color); background: #000; display: flex; justify-content: space-between; align-items: center; }
        .main-container { display: flex; flex: 1; overflow: hidden; flex-direction: row; }
        .canvas-area { flex: 2; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        canvas { background: transparent; box-shadow: 0 0 30px #000; max-width: 100%; height: auto; }
        #ocrLoading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: var(--accent-color); padding: 20px; border: 2px solid var(--accent-color); z-index: 100; display: none; text-align: center; }
        .input-panel { flex: 1; min-width: 320px; max-width: 400px; background: var(--panel-color); padding: 15px; border-left: 2px solid var(--accent-color); overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--accent-color); margin-bottom: 2px; }
        .input-group input, .input-group select { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; font-size: 1rem; box-sizing: border-box; }
        .btn-photo { width: 100%; padding: 12px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; border-radius: 4px; }
        .btn-machine { background: var(--accent-color); color: #000; }
        .btn-doc { background: #ff9900; color: #000; }
        #imgPreview { width: 100%; margin-top: 5px; border: 1px solid #444; display: none; }
        @media (max-width: 768px) { .main-container { flex-direction: column; } .input-panel { border-left: none; border-top: 2px solid var(--accent-color); max-width: 100%; } }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold;">UT-VISUALIZER // v24</div>
    <div style="font-size: 0.7rem; opacity: 0.7;">Operator: HIGA</div>
</header>

<div class="main-container">
    <div class="canvas-area">
        <canvas id="utCanvas" width="800" height="500"></canvas>
        <div id="ocrLoading">
            <div id="ocrStatus">AIè§£æä¸­...</div>
            <div id="ocrProgress">0%</div>
        </div>
    </div>

    <div class="input-panel">
        <div class="input-group">
            <label>æ¿åš T (mm)</label>
            <select id="thickness" onchange="draw()">
                <option value="9">9 mm</option><option value="12">12 mm</option><option value="16">16 mm</option><option value="19">19 mm</option><option value="22">22 mm</option><option value="25" selected>25 mm</option><option value="50">50 mm</option>
            </select>
        </div>
        <div class="input-group"><label>å±ˆæŠ˜è§’ Î¸ (deg)</label><input type="number" id="angle" value="70" step="0.1" oninput="draw()"></div>
        <div class="input-group"><label>æ¢è§¦å­ä½ç½® Y0 (mm)</label><input type="number" id="probePos" value="75" oninput="draw()"></div>
        <div class="input-group"><label>ãƒ“ãƒ¼ãƒ è·¯ç¨‹ W (mm)</label><input type="number" id="beamPath" value="80" step="0.1" oninput="draw()" style="background:#222; color:var(--accent-color);"></div>
        
        <div style="display: flex; gap: 8px; margin: 10px 0;">
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            <button class="btn-photo btn-machine" onclick="mode='machine';fileInput.click()">ğŸ¯æ¢å‚·å™¨</button>
            <button class="btn-photo btn-doc" onclick="mode='doc';fileInput.click()">ğŸ“„æ¤œæŸ»è¡¨</button>
        </div>
        <img id="imgPreview">
        <div id="ocrLog" style="font-size:0.7rem; color:#888; white-space:pre-wrap"></div>

        <div class="input-group"><label>æ·±ã• d (mm)</label><input type="number" id="depth" readonly></div>
        <div class="input-group"><label>æ°´å¹³è·é›¢ y (mm)</label><input type="number" id="distance" readonly></div>
        
        <div style="text-align:center; font-size:0.6rem; color:#555; margin-top:auto;">MIYAMASA KOGYO DESIGN DEPT.</div>
    </div>
</div>

<script>
    let mode = 'machine';
    const canvas = document.getElementById('utCanvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('fileInput');


    // --- OCRå‰å‡¦ç†ï¼ˆæ•°å­—å‘ã‘ï¼‰---
    // ç›®çš„ï¼šæ’®å½±ãƒ ãƒ©ï¼æš—ã„èƒŒæ™¯ï¼åœ§ç¸®ãƒã‚¤ã‚ºã§ã‚‚ã€Œé»’æ–‡å­— on ç™½èƒŒæ™¯ã€ã«å¯„ã›ã¦ç²¾åº¦ã‚’ä¸Šã’ã‚‹
    function preprocessForDigits(srcCanvas) {
        const w = srcCanvas.width, h = srcCanvas.height;
        const ctx = srcCanvas.getContext('2d');
        const img = ctx.getImageData(0, 0, w, h);
        const d = img.data;

        // 1) ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ–
        const gray = new Uint8ClampedArray(w * h);
        for (let i = 0, p = 0; i < d.length; i += 4, p++) {
            gray[p] = (0.299 * d[i] + 0.587 * d[i + 1] + 0.114 * d[i + 2]) | 0;
        }

        // 2) å¤§æ´¥ã®äºŒå€¤åŒ–ï¼ˆOtsuï¼‰
        const hist = new Array(256).fill(0);
        for (let i = 0; i < gray.length; i++) hist[gray[i]]++;
        const total = gray.length;

        let sum = 0;
        for (let t = 0; t < 256; t++) sum += t * hist[t];

        let sumB = 0, wB = 0, wF = 0;
        let varMax = 0, threshold = 128;

        for (let t = 0; t < 256; t++) {
            wB += hist[t];
            if (wB === 0) continue;
            wF = total - wB;
            if (wF === 0) break;

            sumB += t * hist[t];
            const mB = sumB / wB;
            const mF = (sum - sumB) / wF;
            const between = wB * wF * (mB - mF) * (mB - mF);

            if (between > varMax) {
                varMax = between;
                threshold = t;
            }
        }

        // 3) äºŒå€¤åŒ–ï¼ˆé»’0 / ç™½255ï¼‰
        let black = 0;
        for (let i = 0, p = 0; i < d.length; i += 4, p++) {
            const v = gray[p] < threshold ? 0 : 255;
            if (v === 0) black++;
            d[i] = d[i + 1] = d[i + 2] = v;
            d[i + 3] = 255;
        }

        // 4) è‡ªå‹•åè»¢ï¼ˆèƒŒæ™¯ãŒé»’å„ªå‹¢ãªã‚‰ã€ç™½èƒŒæ™¯ã«åè»¢ï¼‰
        if (black / total > 0.5) {
            for (let i = 0; i < d.length; i += 4) {
                const v = 255 - d[i];
                d[i] = d[i + 1] = d[i + 2] = v;
            }
        }

        // 5) è»½ã„ã€Œå¤ªã‚‰ã›ã€ï¼ˆ1å›ã ã‘ã®ç°¡æ˜“dilationï¼šç´°ã„æ•°å­—ãŒæ¬ ã‘ã«ãããªã‚‹ï¼‰
        const bin = new Uint8ClampedArray(total);
        for (let p = 0, i = 0; p < total; p++, i += 4) bin[p] = d[i]; // 0 or 255

        const out = new Uint8ClampedArray(total);
        out.set(bin);
        const idx = (x, y) => y * w + x;

        for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
                const p = idx(x, y);
                if (bin[p] === 0) {
                    out[idx(x - 1, y)] = 0;
                    out[idx(x + 1, y)] = 0;
                    out[idx(x, y - 1)] = 0;
                    out[idx(x, y + 1)] = 0;
                }
            }
        }

        for (let p = 0, i = 0; p < total; p++, i += 4) {
            const v = out[p];
            d[i] = d[i + 1] = d[i + 2] = v;
        }

        ctx.putImageData(img, 0, 0);
    }


    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        document.getElementById('ocrLoading').style.display = 'block';
        document.getElementById('ocrLog').innerText = "å‰å‡¦ç†ä¸­...";

        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = async () => {
                // --- ç”»åƒå‡¦ç† (ç¾å ´ç‰¹åŒ–å‹) ---
                // è§£åƒåº¦ãŒè¶³ã‚Šãªã„ã¨æ•°å­—ãŒæ½°ã‚Œã‚‹ã®ã§ã€ã„ã£ãŸã‚“å¤§ãã‚ã«ãƒªã‚µã‚¤ã‚ºã—ã¦ã‹ã‚‰äºŒå€¤åŒ–
                const TARGET_W = 1400;
                const workCanvas = document.createElement('canvas');
                const workCtx = workCanvas.getContext('2d', { willReadFrequently: true });

                workCanvas.width = TARGET_W;
                workCanvas.height = Math.round(img.height * (TARGET_W / img.width));

                workCtx.imageSmoothingEnabled = true;
                workCtx.imageSmoothingQuality = 'high';
                workCtx.drawImage(img, 0, 0, workCanvas.width, workCanvas.height);

                // æ•°å­—OCRå‘ã‘å‰å‡¦ç†ï¼ˆäºŒå€¤åŒ–ï¼‹è‡ªå‹•åè»¢ï¼‹è»½ã„å¤ªã‚‰ã›ï¼‰
                preprocessForDigits(workCanvas);

                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆPNGï¼šJPEGã®åœ§ç¸®ãƒã‚¤ã‚ºã‚’é¿ã‘ã‚‹ï¼‰
                const previewUrl = workCanvas.toDataURL('image/png');
                document.getElementById('imgPreview').src = previewUrl;
                document.getElementById('imgPreview').style.display = 'block';

                try {
                    const worker = await Tesseract.createWorker({
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                document.getElementById('ocrProgress').innerText = Math.round(m.progress * 100) + '%';
                            } else if (m.status) {
                                document.getElementById('ocrStatus').innerText = m.status + '...';
                            }
                        }
                    });

                    // æ•°å­—ã ã‘æ‹¾ã†ãªã‚‰è‹±èªãƒ¢ãƒ‡ãƒ«ã§OKï¼ˆè»½ã„ï¼‰ã€‚æ–‡å­—ã‚‚å¿…è¦ãªã‚‰ 'jpn' ã«å¤‰æ›´ã€‚
                    await worker.loadLanguage('eng');
                    await worker.initialize('eng');

                    // PSMï¼šæ¢å‚·å™¨ã¯ã€Œ1è¡Œ/1ãƒ–ãƒ­ãƒƒã‚¯ã€æ‰±ã„ãŒå®‰å®šã—ã‚„ã™ã„
                    await worker.setParameters({
                        tessedit_char_whitelist: '0123456789.',
                        classify_bln_numeric_mode: '1',
                        user_defined_dpi: '300',
                        tessedit_pageseg_mode: (mode === 'machine') ? '7' : '6', // 7=single line, 6=single block
                        tessedit_ocr_engine_mode: '1' // LSTM only
                    });

                    const { data: { text } } = await worker.recognize(workCanvas);
                    await worker.terminate();

                    // ã‚ˆãã‚ã‚‹èª¤èªè­˜ã®è»½ã„è£œæ­£ï¼ˆOâ†”0, I/lâ†”1, Sâ†”5, Bâ†”8 ãªã©ï¼‰
                    const fixed = text
                        .replace(/[Ooã€‡]/g, '0')
                        .replace(/[Il|]/g, '1')
                        .replace(/[Ss]/g, '5')
                        .replace(/[Bb]/g, '8');

                    const nums = fixed.match(/\d+(\.\d+)?/g);
                    document.getElementById('ocrLog').innerText =
                        "OCR RAW:\\n" + text.trim() + "\\n\\nOCR FIXED:\\n" + fixed.trim() + "\\n\\nNUMS:\\n" + (nums ? nums.join(', ') : '(none)');

                    if (nums && nums.length > 0) {
                        const parsed = nums.map(Number).filter(n => n > 5 && n < 500);

                        if (mode === 'machine') {
                            // æ¢å‚·å™¨ï¼šå€™è£œãŒè¤‡æ•°ã‚ã‚‹æ™‚ã¯ã€Œæœ€å¤§å€¤ã€ã‚’æ¡ç”¨ï¼ˆWãŒä¸€ç•ªå¤§ãã„å‰æï¼‰
                            document.getElementById('beamPath').value = Math.max(...parsed);
                        } else {
                            // æ¤œæŸ»è¡¨ï¼šå±ˆæŠ˜è§’(60-80)ã‚’åŸºæº–ã«å‰å¾Œã‚’æ‹¾ã†
                            let thIdx = parsed.findIndex(n => n >= 60 && n <= 80);
                            if (thIdx !== -1) {
                                if (parsed[thIdx - 2]) document.getElementById('thickness').value = Math.round(parsed[thIdx - 2]);
                                document.getElementById('angle').value = parsed[thIdx];
                                if (parsed[thIdx + 2]) document.getElementById('probePos').value = parsed[thIdx + 2];
                                if (parsed[thIdx + 3]) document.getElementById('beamPath').value = parsed[thIdx + 3];
                            }
                        }
                        draw();
                    } else {
                        alert("æ•°å­—ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã€‚ã‚‚ã£ã¨ã‚¢ãƒƒãƒ—ã§æ’®ã£ã¦ã€æ˜ã‚‹ã•/åå°„ã‚’é¿ã‘ã¦ãã ã•ã„ã€‚");
                    }
                } catch (err) {
                    console.error(err);
                    alert("OCRã‚¨ãƒ©ãƒ¼ï¼ˆè©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼‰");
                }
                document.getElementById('ocrLoading').style.display = 'none';
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    function draw() {
        const T = parseFloat(document.getElementById('thickness').value);
        const theta = (parseFloat(document.getElementById('angle').value)) * (Math.PI / 180);
        const Y0 = parseFloat(document.getElementById('probePos').value);
        const W = parseFloat(document.getElementById('beamPath').value);

        const y = W * Math.sin(theta);
        const d_raw = W * Math.cos(theta);
        
        // ç‰©ç†è¨ˆç®— (è£å½“ã¦é‡‘ 9x25)
        const x_at_T = Y0 - T * Math.tan(theta);
        const isBacking = (Math.abs(x_at_T) < 12.5);
        const effT = isBacking ? T + 9 : T;

        let d_disp = (d_raw <= effT) ? d_raw : (effT - (d_raw - effT));
        
        document.getElementById('depth').value = d_disp.toFixed(1);
        document.getElementById('distance').value = y.toFixed(1);

        // æç”»
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const sc = 5.0; const ox = 250; const oy = 250 - (T*sc/2);
        
        ctx.fillStyle = "#333"; ctx.fillRect(ox - 500, oy, 500 - 3.5*sc, T*sc); // æ¿å·¦
        ctx.fillRect(ox + 3.5*sc, oy, 500, T*sc); // æ¿å³
        ctx.fillStyle = "#222"; ctx.fillRect(ox - 12.5*sc, oy + T*sc, 25*sc, 9*sc); // è£å½“ã¦é‡‘
        
        const px = ox + Y0*sc;
        ctx.fillStyle = "#ccc"; ctx.fillRect(px-20, oy-25, 40, 25); // æ¢è§¦å­
        ctx.fillStyle = "red"; ctx.beginPath(); ctx.moveTo(px, oy); ctx.lineTo(px-5, oy-8); ctx.lineTo(px+5, oy-8); ctx.fill(); // å…¥å°„ç‚¹â–½

        ctx.strokeStyle = "#00ff41"; ctx.setLineDash(d_raw > effT ? [5, 5] : []);
        ctx.beginPath(); ctx.moveTo(px, oy);
        if(d_raw <= effT) {
            ctx.lineTo(px - y*sc, oy + d_raw*sc);
        } else {
            const rx = px - effT * Math.tan(theta) * sc;
            ctx.lineTo(rx, oy + effT*sc); ctx.lineTo(px - y*sc, oy + d_disp*sc);
        }
        ctx.stroke();

        ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(px - y*sc, oy + d_disp*sc, 6, 0, 7); ctx.fill(); // ããš
    }
    draw();
</script>
</body>
</html>