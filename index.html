<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UT-Visualizer Pro (v24: Miyasho Special)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --bg-color: #1a1a1a; --panel-color: #262626; --accent-color: #00ff41; --text-color: #e0e0e0; --grid-color: rgba(0, 255, 65, 0.05); }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Courier New', monospace; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { padding: 10px 20px; border-bottom: 2px solid var(--accent-color); background: #000; display: flex; justify-content: space-between; align-items: center; }
        .main-container { display: flex; flex: 1; overflow: hidden; flex-direction: row; }
        .canvas-area { flex: 2; position: relative; background: #111; display: flex; align-items: center; justify-content: center; }
        canvas { background: transparent; box-shadow: 0 0 30px #000; max-width: 100%; height: auto; }
        #ocrLoading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: var(--accent-color); padding: 20px; border: 2px solid var(--accent-color); z-index: 100; display: none; text-align: center; }
        .input-panel { flex: 1; min-width: 320px; max-width: 400px; background: var(--panel-color); padding: 15px; border-left: 2px solid var(--accent-color); overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--accent-color); margin-bottom: 2px; }
        .input-group input, .input-group select { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 8px; font-size: 1rem; box-sizing: border-box; }
        .btn-photo { width: 100%; padding: 12px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; border-radius: 4px; }
        .btn-machine { background: var(--accent-color); color: #000; }
        .btn-doc { background: #ff9900; color: #000; }
        #imgPreview { width: 100%; margin-top: 5px; border: 1px solid #444; display: none; }
        @media (max-width: 768px) { .main-container { flex-direction: column; } .input-panel { border-left: none; border-top: 2px solid var(--accent-color); max-width: 100%; } }
    </style>
</head>
<body>

<header>
    <div style="font-weight: bold;">UT-VISUALIZER // v24</div>
    <div style="font-size: 0.7rem; opacity: 0.7;">Operator: HIGA</div>
</header>

<div class="main-container">
    <div class="canvas-area">
        <canvas id="utCanvas" width="800" height="500"></canvas>
        <div id="ocrLoading">
            <div id="ocrStatus">AIËß£Êûê‰∏≠...</div>
            <div id="ocrProgress">0%</div>
        </div>
    </div>

    <div class="input-panel">
        <div class="input-group">
            <label>ÊùøÂéö T (mm)</label>
            <select id="thickness" onchange="draw()">
                <option value="9">9 mm</option><option value="12">12 mm</option><option value="16">16 mm</option><option value="19">19 mm</option><option value="22">22 mm</option><option value="25" selected>25 mm</option><option value="50">50 mm</option>
            </select>
        </div>
        <div class="input-group"><label>Â±àÊäòËßí Œ∏ (deg)</label><input type="number" id="angle" value="70" step="0.1" oninput="draw()"></div>
        <div class="input-group"><label>Êé¢Ëß¶Â≠ê‰ΩçÁΩÆ Y0 (mm)</label><input type="number" id="probePos" value="75" oninput="draw()"></div>
        <div class="input-group"><label>„Éì„Éº„É†Ë∑ØÁ®ã W (mm)</label><input type="number" id="beamPath" value="80" step="0.1" oninput="draw()" style="background:#222; color:var(--accent-color);"></div>
        
        <div style="display: flex; gap: 8px; margin: 10px 0;">
            <input type="file" id="fileInput" accept="image/*" style="display:none">
            <button class="btn-photo btn-machine" onclick="mode='machine';fileInput.click()">üéØÊé¢ÂÇ∑Âô®</button>
            <button class="btn-photo btn-doc" onclick="mode='doc';fileInput.click()">üìÑÊ§úÊüªË°®</button>
        </div>
        <img id="imgPreview">
        <div id="ocrLog" style="font-size:0.7rem; color:#888; white-space:pre-wrap"></div>

        <div class="input-group"><label>Ê∑±„Åï d (mm)</label><input type="number" id="depth" readonly></div>
        <div class="input-group"><label>Ê∞¥Âπ≥Ë∑ùÈõ¢ y (mm)</label><input type="number" id="distance" readonly></div>
        
        <div style="text-align:center; font-size:0.6rem; color:#555; margin-top:auto;">MIYAMASA KOGYO DESIGN DEPT.</div>
    </div>
</div>

<script>
    let mode = 'machine';
    const canvas = document.getElementById('utCanvas');
    const ctx = canvas.getContext('2d');
    const fileInput = document.getElementById('fileInput');

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        document.getElementById('ocrLoading').style.display = 'block';
        document.getElementById('ocrLog').innerText = "ÂâçÂá¶ÁêÜ‰∏≠...";

        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = async () => {
                // --- ÁîªÂÉèÂá¶ÁêÜ (ÁèæÂ†¥ÁâπÂåñÂûã) ---
                const workCanvas = document.createElement('canvas');
                const workCtx = workCanvas.getContext('2d');
                workCanvas.width = 600; workCanvas.height = img.height * (600 / img.width);
                workCtx.filter = 'contrast(200%) grayscale(100%) brightness(120%)';
                workCtx.drawImage(img, 0, 0, workCanvas.width, workCanvas.height);
                
                const dataUrl = workCanvas.toDataURL('image/jpeg');
                document.getElementById('imgPreview').src = dataUrl;
                document.getElementById('imgPreview').style.display = 'block';

                try {
                    const worker = await Tesseract.createWorker({
                        logger: m => { if(m.status === 'recognizing text') document.getElementById('ocrProgress').innerText = Math.round(m.progress*100)+'%'; }
                    });
                    await worker.loadLanguage('eng');
                    await worker.initialize('eng');
                    await worker.setParameters({ tessedit_char_whitelist: '0123456789. ' });

                    const { data: { text } } = await worker.recognize(dataUrl);
                    await worker.terminate();

                    const nums = text.match(/\d+(\.\d+)?/g);
                    if(nums && nums.length > 0) {
                        const parsed = nums.map(Number).filter(n => n > 5 && n < 500);
                        if(mode === 'machine') {
                            document.getElementById('beamPath').value = Math.max(...parsed);
                        } else {
                            // Ê§úÊüªË°®„É≠„Ç∏„ÉÉ„ÇØ: Â±àÊäòËßí(60-80)„ÇíÂü∫Ê∫ñ„Å´ÂâçÂæå„ÇíÊãæ„ÅÜ
                            let thIdx = parsed.findIndex(n => n >= 60 && n <= 80);
                            if(thIdx !== -1) {
                                if(parsed[thIdx-2]) document.getElementById('thickness').value = Math.round(parsed[thIdx-2]);
                                document.getElementById('angle').value = parsed[thIdx];
                                if(parsed[thIdx+2]) document.getElementById('probePos').value = parsed[thIdx+2];
                                if(parsed[thIdx+3]) document.getElementById('beamPath').value = parsed[thIdx+3];
                            }
                        }
                        draw();
                    } else { alert("Êï∞Â≠ó„ÅåÊ§úÂá∫„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„ÇÇ„Å£„Å®„Ç¢„ÉÉ„Éó„ÅßÊíÆ„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"); }
                } catch(err) { alert("OCR„Ç®„É©„Éº"); }
                document.getElementById('ocrLoading').style.display = 'none';
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    function draw() {
        const T = parseFloat(document.getElementById('thickness').value);
        const theta = (parseFloat(document.getElementById('angle').value)) * (Math.PI / 180);
        const Y0 = parseFloat(document.getElementById('probePos').value);
        const W = parseFloat(document.getElementById('beamPath').value);

        const y = W * Math.sin(theta);
        const d_raw = W * Math.cos(theta);
        
        // Áâ©ÁêÜË®àÁÆó (Ë£èÂΩì„Å¶Èáë 9x25)
        const x_at_T = Y0 - T * Math.tan(theta);
        const isBacking = (Math.abs(x_at_T) < 12.5);
        const effT = isBacking ? T + 9 : T;

        let d_disp = (d_raw <= effT) ? d_raw : (effT - (d_raw - effT));
        
        document.getElementById('depth').value = d_disp.toFixed(1);
        document.getElementById('distance').value = y.toFixed(1);

        // ÊèèÁîª
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const sc = 5.0; const ox = 250; const oy = 250 - (T*sc/2);
        
        ctx.fillStyle = "#333"; ctx.fillRect(ox - 500, oy, 500 - 3.5*sc, T*sc); // ÊùøÂ∑¶
        ctx.fillRect(ox + 3.5*sc, oy, 500, T*sc); // ÊùøÂè≥
        ctx.fillStyle = "#222"; ctx.fillRect(ox - 12.5*sc, oy + T*sc, 25*sc, 9*sc); // Ë£èÂΩì„Å¶Èáë
        
        const px = ox + Y0*sc;
        ctx.fillStyle = "#ccc"; ctx.fillRect(px-20, oy-25, 40, 25); // Êé¢Ëß¶Â≠ê
        ctx.fillStyle = "red"; ctx.beginPath(); ctx.moveTo(px, oy); ctx.lineTo(px-5, oy-8); ctx.lineTo(px+5, oy-8); ctx.fill(); // ÂÖ•Â∞ÑÁÇπ‚ñΩ

        ctx.strokeStyle = "#00ff41"; ctx.setLineDash(d_raw > effT ? [5, 5] : []);
        ctx.beginPath(); ctx.moveTo(px, oy);
        if(d_raw <= effT) {
            ctx.lineTo(px - y*sc, oy + d_raw*sc);
        } else {
            const rx = px - effT * Math.tan(theta) * sc;
            ctx.lineTo(rx, oy + effT*sc); ctx.lineTo(px - y*sc, oy + d_disp*sc);
        }
        ctx.stroke();

        ctx.fillStyle = "red"; ctx.beginPath(); ctx.arc(px - y*sc, oy + d_disp*sc, 6, 0, 7); ctx.fill(); // „Åç„Åö
    }
    draw();
</script>
</body>
</html>